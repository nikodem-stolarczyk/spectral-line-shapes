(* ::Package:: *)

(* ::Input::Initialization:: *)
BeginPackage["CPFLib`"]
mHT::usage="a";
CPFa::usage="asd";

Begin["`Private`"]
e=2.718281828459045;
pi=3.141592653589793;
rp=1.772453850905516;

CPFa=Compile[{{x,_Real},{y,_Real}},Block[{z,L=5.449631621480024},z=-y+x I ;
0.5641895835477563/(L-z)+  2/(L-z)^2  Total[((L+z)/(L-z))^Range[36,0,-1]                      {-3.129493160727961 10^(-14),-1.188364999909099 10^(-14),+1.951777029849348 10^(-13),+1.790586243645278 10^(-13),-1.184560208678836 10^(-12),-2.069163661083667 10^(-12),+6.430136110306704 10^(-12),+2.063579921011804 10^(-11),-2.392389527320517 10^(-11),-1.799169607159564 10^(-10),-6.353807951660892 10^(-11),+1.282896083944607 10^(-09),+2.636162411919059 10^(-09),-5.468780625369738 10^(-09),-3.294773119114329 10^(-08),-2.752070035718561 10^(-08),+2.206733163926054 10^(-07),+8.511689670641750 10^(-07),+4.936972061734341 10^(-07),-6.617492208403963 10^(-06),-2.914574364851397 10^(-05),-4.816473680511106 10^(-05),+1.044072210002090 10^(-04),+1.070131083157417 10^(-03),+4.631075611097791 10^(-03),+1.480296368764821 10^(-02),+3.922970169744468 10^(-02),+9.038744880336540 10^(-02),+1.857036333535562 10^(-01),+3.455278077566057 10^(-01),+5.882708203344523 10^(-01),+9.230959991941070 10^(-01),+1.342044484596932 10^(+00),+1.814714451499866 10^(+00),+2.288734169675538 10^(+00),+2.697763665856064 10^(+00),+2.975931371735470 10^(+00)}]],
RuntimeAttributes->{Listable},Parallelization->True,RuntimeOptions->"Speed"];

CPFf=Compile[{{x,_Real},{y,_Real}},Block[{z,L=4.119534287814236},z=-y+x I;
0.5641895835477563/(L-z)+2/(L-z)^2  Total[((L+z)/(L-z))^Range[23,0,-1]                      {-1.513747622620502 10^(-10),+4.904820407381768 10^(-09),+1.331045329581992 10^(-09),-3.008282344381996 10^(-08),-1.912225887484805 10^(-08),+1.873834346505099 10^(-07),+2.568264135399530 10^(-07),-1.085647579417637 10^(-06),-3.038893184366094 10^(-06),+4.139461724429617 10^(-06),+3.047106608295325 10^(-05),+2.433141546207148 10^(-05),-2.074843151143828 10^(-04),-7.816642995626165 10^(-04),-4.936426901286291 10^(-04),+6.215006362949147 10^(-03),+3.372336685531603 10^(-02),+1.083872348456673 10^(-01),+2.654963959880772 10^(-01),+5.361139535729116 10^(-01),+9.257087138588670 10^(-01),+1.394819673379119 10^(+00),+1.856286499205540 10^(+00),+2.197858936531542 10^(+00)}]],
RuntimeAttributes->{Listable},Parallelization->True,RuntimeOptions->"Speed"];

BetaCorr = Compile[{{\[CapitalGamma]D,_Real},{Re\[Nu]opt,_Real},{\[Alpha],_Real}},
If[\[Alpha]<5,Block[
  {a=0.0534+0.1585Exp[-0.4510\[Alpha]],
  b=1.9595-0.1258\[Alpha]+0.0056\[Alpha]^2+0.0050\[Alpha]^3,
  c=-0.0546+0.0672\[Alpha]-0.0125\[Alpha]^2+0.0003\[Alpha]^3,
  d=0.9466-0.1585Exp[-0.4510\[Alpha]]},
a Tanh[b Log10[Re\[Nu]opt/\[CapitalGamma]D]+c]+d],1.0],
RuntimeAttributes->{Listable},Parallelization->True];

mHT[\[Nu]0_,\[CapitalGamma]D_,\[CapitalGamma]0_,\[CapitalGamma]2_,\[CapitalDelta]0_,\[CapitalDelta]2_,Re\[Nu]opt_,Im\[Nu]opt_,\[Nu]_,Sw_:1.0,Ylm_:0.0,Xlm_:0.0,\[Alpha]_:10.0] :=Block[
{X,Y,csqY,z1,z2,z,r,w1,w2,w,A,Output,cpf=CPFa,
\[Nu]D=\[CapitalGamma]D/0.8325546111576977,
\[Nu]R=Re\[Nu]opt BetaCorr[\[CapitalGamma]D,Re\[Nu]opt,\[Alpha]],
c2=\[CapitalGamma]2+\[CapitalDelta]2 I,
c0=\[CapitalGamma]0+\[CapitalDelta]0 I-1.5 c2 +\[Nu]R+Im\[Nu]opt I,
LM=1+Xlm+Ylm I},
A=If[Abs[c2]!= 0.0,
X        =((\[Nu]0-\[Nu])I+c0)/c2;
Y        =0.25 (\[Nu]D/c2)^2;
csqY =0.50 \[Nu]D (\[CapitalGamma]2-\[CapitalDelta]2 I )/(\[CapitalGamma]2^2+\[CapitalDelta]2^2);
If[Abs[Y]>Abs[X] 10^(-15),
z2=Sqrt[X+Y]+csqY;
z1=If[Abs[X]>Abs[Y] 3 10^(-8),z2-2csqY,((\[Nu]0-\[Nu])I+c0)/\[Nu]D];
w1=cpf[-Im[z1],Re[z1]];
w2=cpf[-Im[z2],Re[z2]];
rp/\[Nu]D(w1-w2),
If[Abs[Sqrt[X]^2]<4 10^3,
r=Sqrt[X];
w=cpf[-Im[r],Re[r]];
2(1-rp r w)/c2,
(1/X-1.5/X^2)/c2]],
z=((\[Nu]0-\[Nu])I+c0)/\[Nu]D;
w=cpf[-Im[z],Re[z]];
w rp/\[Nu]D];
Output =Sw LM A/(pi(1-(\[Nu]R+I Im\[Nu]opt) A));
{Re[Output],Im[Output]}
]
End[]
EndPackage[]


